<p-toast></p-toast>
<p-breadcrumb [model]="items" [home]="home"></p-breadcrumb>
<div class="p-grid">
    <div class="p-col-12">
        <h3 class="p-text-center">{{ email }}</h3>
    </div>
</div>

<div class="p-grid">
    <div class="p-col-12">
        <span class="p-text-center">
            <p-selectButton [options]="detailsOptions" (onChange)="changeData($event.value)" optionLabel="name"
                optionValue="value" [(ngModel)]="detailsOption">
            </p-selectButton>
        </span>
        <p-progressBar mode="indeterminate" [style]="{ height: '5px' }" *ngIf="waiting"></p-progressBar>
        <p-table #dt dataKey="id" [value]="data" [resizableColumns]="true" dataKey="id" *ngIf="detailsOption != 3"
            styleClass="p-datatable-gridlines" [loading]="waiting" [columns]="cols" responsive="true"
            [scrollable]="true" scrollHeight="350px" [style]="{ width: '100%' }" [reorderableColumns]="true"
            [frozenColumns]="frozenCols" frozenWidth="500px" [(selection)]="selected">
            <ng-template pTemplate="caption">
                <div class="p-grid">
                    <div class="p-col-1">
                        <button type="button" pButton pRipple icon="pi pi-arrow-left" (click)="goBack()"
                            class="p-button-rounded p-button-primary" label="{{ 'TextAnalysis.back' | translate }} "
                            pTooltip="{{ 'TextAnalysis.back' | translate }} " tooltipPosition="bottom"></button>
                    </div>
                    <div class="p-col-4">
                        <button type="button" pButton pRipple icon="pi pi-file-excel" (click)="exportExcel()"
                            class="p-button-warning p-mr-2" pTooltip="{{ 'TextAnalysis.export' | translate }}"
                            tooltipPosition="bottom"></button>
                        <button type="button" pButton pRipple icon="pi pi-filter-slash" (click)="clearFilter()"
                            class="p-ml-6 clearFilter" pTooltip="{{ 'Data_Table.clearFilter' | translate }}"
                            *ngIf="filtersNo > 0" tooltipPosition="bottom"></button>
                        <button type="button" pButton pRipple icon="pi pi-check" (click)="saveRelevant()"
                            class="p-button-primary p-mr-2" pTooltip="{{ 'Analysis.save' | translate }}"
                            tooltipPosition="bottom" label="{{ 'Analysis.saveRelevant' | translate }}"></button>
                    </div>
                </div>
            </ng-template>
            <ng-template pTemplate="colgroup" let-columns>
                <colgroup>
                    <col *ngFor="let col of columns" [style]="{ width: (col.width ? col.width : 200) + 'px' }" />
                </colgroup>
            </ng-template>
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th pSortableColumn="{{ col.field }}" pResizableColumn pReorderableColumn
                        class="p-text-{{col.align}}" *ngFor="let col of columns">
                        {{ col.header | translate }}
                        <p-sortIcon field="{{ col.field }}"></p-sortIcon>
                    </th>
                </tr>
                <tr>
                    <!-- <th></th> -->
                    <th pResizableColumn *ngFor="let col of columns" class="autocomplete">
                        <input
                            *ngIf="col.field != 'senderRelevant' && col.field != 'creationTime' && col.field != 'messageDeliveryTime'"
                            pInputText type="text" [(ngModel)]="criteria[col.field]" [style]="{ width: '90%' }"
                            (input)="filterChange($any($event.target).value, col.field)" class="filterInputCss" />
                        <p-calendar *ngIf="
              col.field == 'creationTime' ||
              col.field == 'messageDeliveryTime'            " [(ngModel)]="criteria[col.field]"
                            (onSelect)="filterChange($event, col.field)" [monthNavigator]="true" [yearNavigator]="true"
                            yearRange="1900:2100" appendTo="body" dateFormat="dd.mm.yy">
                        </p-calendar>
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row let-columns="columns">
                <tr>
                    <td pEditableColumn pReorderableRowHandle *ngFor="let col of columns"
                        class="p-text-{{ col.align }}">
                        <span *ngIf="col.field == 'senderRelevant'">
                            <i class="pi pi-star-o" (click)="selectRow(row)" *ngIf="!row.senderRelevant"></i>
                            <i class="pi pi-star" (click)="selectRow(row)" *ngIf="row.senderRelevant"></i>
                        </span>
                        <p-cellEditor *ngIf="col.field == 'senderComment'">
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="row.senderComment"
                                    style="width: 100%; padding: 5px" (change)="commentChanged(row)" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ row.senderComment }}
                            </ng-template>
                        </p-cellEditor>
                        <span *ngIf="
                col.field == 'creationTime' ||
                col.field == 'messageDeliveryTime'
              ">
                            {{ row[col.field] | date: "dd.MM.yyyy" }}
                        </span>
                        <span (click)="hoverOnBody($event, row[col.field])" *ngIf="
                col.field == 'subject' ||
                col.field == 'body' ||
                col.field == 'bodyHTML'
              " [innerHTML]="row[col.field] | highlight">
                        </span>
                        <span pTooltip="{{ row[col.field] }}" *ngIf="
                col.field != 'creationTime' &&
                col.field != 'messageDeliveryTime' &&
                col.field != 'subject' &&
                col.field != 'body' &&
                col.field != 'bodyHTML' &&
                col.field != 'actions' &&
                col.field != 'senderRelevant' &&
                col.field != 'senderComment'
              ">
                            {{ row[col.field] }}
                        </span>
                        <span *ngIf="col.field == 'actions'">
                            <button type="button" pButton pRipple icon="pi pi-files" (click)="attachDetailes(row)"
                                class="p-button-rounded p-button-primary" label="Attachments" pTooltip="Attachments"
                                tooltipPosition="bottom"></button></span>
                    </td>

                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
                <tr>
                    <td [attr.colspan]="columns.length">No records found</td>
                </tr>
            </ng-template>
        </p-table>
        <p-table #dtall dataKey="id" [value]="allRecordData" [resizableColumns]="true" dataKey="id"
            *ngIf="detailsOption == 3" styleClass="p-datatable-gridlines" [loading]="waiting" [columns]="cols"
            responsive="true" [scrollable]="true" scrollHeight="350px" [style]="{ width: '100%' }"
            [reorderableColumns]="true" [frozenColumns]="frozenCols" frozenWidth="500px" [(selection)]="selected"
            [lazy]="true" [customSort]="true" (onLazyLoad)="sort($event)">
            <ng-template pTemplate="caption">
                <div class="p-grid">
                    <div class="p-col-1">
                        <button type="button" pButton pRipple icon="pi pi-arrow-left" (click)="goBack()"
                            class="p-button-rounded p-button-primary" label="{{ 'TextAnalysis.back' | translate }} "
                            pTooltip="{{ 'TextAnalysis.back' | translate }} " tooltipPosition="bottom"></button>
                    </div>
                    <div class="p-col-4">
                        <button type="button" pButton pRipple icon="pi pi-file-excel" (click)="exportXLSX()"
                            class="p-button-warning p-mr-2" pTooltip="{{ 'TextAnalysis.export' | translate }}"
                            tooltipPosition="bottom"></button>
                        <button type="button" pButton pRipple icon="pi pi-check" (click)="saveRelevant()"
                            class="p-button-primary p-mr-2" pTooltip="{{ 'Analysis.save' | translate }}"
                            tooltipPosition="bottom" label="{{ 'Analysis.saveRelevant' | translate }}"></button>
                    </div>
                    <div class="p-col-7">
                        <!-- Limit options -->
                        <p-dropdown [options]="pageLimitSizes" optionValue="value" optionLabel="value"
                            [(ngModel)]="limit" (onChange)="limitChange($event)" class="p-mr-2"></p-dropdown>
                        <!-- Go to First page -->
                        <button type="button" [disabled]="pageNr === 1" pButton pRipple icon="pi pi-angle-double-left"
                            (click)="firstPage()" class="p-mr-2" pTooltip="{{ 'Data_Table.firstPage' | translate }}"
                            tooltipPosition="bottom"></button>
                        <!-- Go previous -->
                        <button type="button" [disabled]="pageNr === 1" pButton pRipple icon="pi pi-angle-left"
                            (click)="previousPage()" class="p-mr-2" pTooltip="{{ 'Data_Table.previous' | translate }}"
                            tooltipPosition="bottom"></button>
                        <!-- Page number -->
                        <input pInputText type="number" min="1" class="pageNrInput p-mr-2"
                            (input)="pageNrChange($any($event.target).value)" [value]="pageNr" [placeholder]="pageNr" />
                        <!-- Go to next Page -->
                        <button type="button" [disabled]="pageNr >= maxPageNr" pButton pRipple icon="pi pi-angle-right"
                            (click)="nextPage()" class="p-mr-2" pTooltip="{{ 'Data_Table.next' | translate }}"
                            tooltipPosition="bottom"></button>
                        <!-- Go to last page -->
                        <button type="button" [disabled]="pageNr >= maxPageNr" pButton pRipple
                            icon="pi pi-angle-double-right" (click)="lastPage()" class="p-mr-2"
                            pTooltip="{{ 'Data_Table.lastPage' | translate }}" tooltipPosition="bottom"></button>

                        <!-- dispalyed data of total count -->
                        {{ displayedDataCount }} of {{ totalCount }}
                        <!-- Clear filter -->
                        <button type="button" pButton pRipple icon="pi pi-filter-slash" (click)="clearBackFilter()"
                            class="p-ml-6 clearFilter" pTooltip="{{ 'Data_Table.clearFilter' | translate }}"
                            *ngIf="filtersBackNo > 0" tooltipPosition="bottom"></button>
                    </div>
                </div>
            </ng-template>
            <ng-template pTemplate="colgroup" let-columns>
                <colgroup>
                    <col *ngFor="let col of columns" [style]="{ width: (col.width ? col.width : 200) + 'px' }" />
                </colgroup>
            </ng-template>
            <ng-template pTemplate="header" let-columns>
                <tr>
                    <th pSortableColumn="{{ col.field }}" pResizableColumn pReorderableColumn
                        class="p-text-{{ col.align }}" *ngFor="let col of columns">
                        {{ col.header | translate }}
                        <p-sortIcon field="{{ col.field }}"></p-sortIcon>
                    </th>
                </tr>
                <tr>
                    <th pResizableColumn *ngFor="let col of columns" class="autocomplete">
                        <input
                            *ngIf="col.field != 'senderRelevant' && col.field != 'creationTime' && col.field != 'messageDeliveryTime'"
                            pInputText type="text" [(ngModel)]="criteria[col.field]" [style]="{ width: '90%' }"
                            (input)="filterChange($any($event.target).value, col.field)" class="filterInputCss" />
                        <p-calendar *ngIf="
              col.field == 'creationTime' ||
              col.field == 'messageDeliveryTime'            " [(ngModel)]="criteria[col.field]"
                            (onSelect)="filterChange($event, col.field)" [monthNavigator]="true" [yearNavigator]="true"
                            yearRange="1900:2100" appendTo="body" dateFormat="dd.mm.yy">
                        </p-calendar>
                    </th>
                </tr>
            </ng-template>
            <ng-template pTemplate="body" let-row let-columns="columns">
                <tr>
                    <td pEditableColumn pReorderableRowHandle *ngFor="let col of columns"
                        class="p-text-{{ col.align }}">
                        <span *ngIf="col.field == 'senderRelevant'">
                            <i class="pi pi-star-o" (click)="selectRow(row)" *ngIf="!row.senderRelevant"></i>
                            <i class="pi pi-star" (click)="selectRow(row)" *ngIf="row.senderRelevant"></i>
                        </span>
                        <p-cellEditor *ngIf="col.field == 'senderComment'">
                            <ng-template pTemplate="input">
                                <input pInputText type="text" [(ngModel)]="row.senderComment"
                                    style="width: 100%; padding: 5px" (change)="commentChanged(row)" />
                            </ng-template>
                            <ng-template pTemplate="output">
                                {{ row.senderComment }}
                            </ng-template>
                        </p-cellEditor>
                        <span *ngIf="
                col.field == 'creationTime' ||
                col.field == 'messageDeliveryTime'
              ">
                            {{ row[col.field] | date: "dd.MM.yyyy" }}
                        </span>
                        <span (click)="hoverOnBody($event, row[col.field])" *ngIf="
                col.field == 'subject' ||
                col.field == 'body' ||
                col.field == 'bodyHTML'
              " [innerHTML]="row[col.field] | highlight">
                        </span>
                        <span pTooltip="{{ row[col.field] }}" *ngIf="
                col.field != 'creationTime' &&
                col.field != 'messageDeliveryTime' &&
                col.field != 'subject' &&
                col.field != 'body' &&
                col.field != 'bodyHTML' &&
                col.field != 'actions' &&
                col.field != 'senderRelevant' &&
                col.field != 'senderComment'
              ">
                            {{ row[col.field] }}
                        </span>
                        <span *ngIf="col.field == 'actions'">
                            <button type="button" pButton pRipple icon="pi pi-files" (click)="attachDetailes(row)"
                                class="p-button-rounded p-button-primary" label="Attachments" pTooltip="Attachments"
                                tooltipPosition="bottom"></button></span>
                    </td>
                </tr>
            </ng-template>
            <ng-template pTemplate="emptymessage" let-columns>
                <tr>
                    <td [attr.colspan]="columns.length">No records found</td>
                </tr>
            </ng-template>
        </p-table>
    </div>
</div>

<p-dialog header="Details" [(visible)]="displayDialog" [style]="{width: '100%', 'overflow-wrap': 'anywhere'}">
    {{body}}
</p-dialog>

<p-dialog header="Attachments Details" [(visible)]="displayAttachDialog" [style]="{width: '100%', 'overflow-wrap': 'anywhere'}">
    <ul>
        <li *ngFor="let attach of attachments">
            <a (click)="downloadAttach(attach)">{{attach.originalName}} - {{attach.size / 1024}} KB</a>
        </li>
    </ul>
</p-dialog>